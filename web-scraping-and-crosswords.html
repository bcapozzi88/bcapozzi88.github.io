<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta property="og:title" content="Web Scraping and Crosswords"/>
    <meta property="og:url" content="/web-scraping-and-crosswords.html"/>
    <meta property="og:site_name" content="Brian Capozzi"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="/web-scraping-and-crosswords.html" />

    <title>Web Scraping and Crosswords | Brian Capozzi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="/theme/css/bootstrap-responsive.min.css" type="text/css" />

    <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="/">Brian Capozzi </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li><a href="/pages/about-me.html">About Me</a></li>
                            <li class="active"><a href="/category/posts.html">Posts</a></li>
                        </ul>

                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="/web-scraping-and-crosswords.html" rel="bookmark"
             title="Permalink to Web Scraping and Crosswords">Web Scraping and Crosswords</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="/author/brian-capozzi.html">Brian Capozzi</a>
    </address>

    in <a href="/category/posts.html">Posts</a>

    on 2014-09-24




    
</footer><!-- /.post-info -->

        <hr />
<p>I love crossword puzzles. I do the New York Times crossword puzzle almost every day-- though, I don't actually finish it every day. The puzzle difficulty ramps up as the week progresses, with Monday being the easiest, Saturday being the toughest, and Sunday being a larger puzzle at a Wednesday/Thursday-ish difficulty. Sunday through Thursday puzzles also generally have some sort of theme, while Friday and Saturday puzzles are unthemed. I can usually complete puzzles through Thursday difficulty, occassionally I can finish a Friday puzzle, but I've never even come close to finishing a Saturday.</p>
<p>Rex Parker, the 63rd greatest crossword solver in the universe, has a blog, <a href="http://rexwordpuzzle.blogspot.com">Rex Parker Does the NY Times Crossword Puzzle</a> where he documents each puzzle's constructor and theme, assigns a relative difficulty to the puzzle, and writes his thoughts on the puzzle's fill. I really enjoy reading it, so this seemed like a fun place to get my feet wet learning to web scrape using Python. In particular, there are a few questions that I thought might be interesting to answer, such as:</p>
<ul>
<li>Who has created the most NYT crosswords?</li>
<li>Do any constructors make particularly hard early-week puzzles or particularly easy late-week puzzles?</li>
<li>Is there a difference in male/female constructors for themed/unthemed puzzles? Rex once commented about there being very few unthemed puzzles created by women, and I wondered how true this was.</li>
<li>Is Rex a grouch? Many commenters seem to think he has negative opinions of most puzzles (I think he's fine).</li>
</ul>
<h2>Web Scraping 101</h2>
<p>Before attempting to answer any of the above questions, we need to actually get some data off of Rex's blog. The home page on the blog looks something like this:</p>
<p><img alt="" src="https://github.com/bcapozzi88/bcapozzi88.github.io/blob/master/images/Rex_blogshot.png" /></p>
<p>It displays the current day's crossword puzzle. The link to a given day's crossword puzzle looks something like this: <a href="http://rexwordpuzzle.blogspot.com/2014/09/snowman-in-disneys-frozen-tue-9-23-14.html">http://rexwordpuzzle.blogspot.com/2014/09/snowman-in-disneys-frozen-tue-9-23-14.html</a>, with the date towards the end of the url. There is a lot going on on each page of Rex's blog-- there are lots of links, images, and text extraneous to the body of the day's post. The information that I would like to collect from each page is the puzzle date, the body of the blog post (which also contains constructor, difficulty, and theme), and the link to the prior day's puzzle.</p>
<h3>Beautiful Soup</h3>
<p>To start, we can get a feel for what the underlying HTML of Rex's blog looks like:</p>
<p>![]</p>
<p>In order to begin playing around, we can open the webpage using Python's urllib2 library, and convert the file to a BeautifulSoup object, giving us a 'beautiful' (oh no), nested structure to work with.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">test_url</span> <span class="o">=</span> <span class="s">&#39;http://rexwordpuzzle.blogspot.com/2014/09/resin-used-in-incense-tue-9-16-14-1990s.html&#39;</span>
<span class="n">web_page</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">test_url</span><span class="p">)</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span>
</pre></div>


<p>The BeautifulSoup object looks much like the HTML, but allows us to easily search through the webpage for specific tags in order to find what we want. For instance, the post date, which is stored in a line that looks like this:</p>
<div class="highlight"><pre><span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">&quot;date-header&quot;</span><span class="nt">&gt;</span>Tuesday, September 23, 2014<span class="nt">&lt;/h2&gt;</span>
</pre></div>


<p>can be found simply by saying:</p>
<div class="highlight"><pre><span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;h2&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span> <span class="s">&#39;date-header&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</pre></div>


<p>This will return the string 'Tuesday, September 23, 2014'
Similarly, the entirety of the post body can be found starting with a line that looks like this:</p>
<div class="highlight"><pre><span class="o">&lt;/</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;post-body&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;post-########&quot;</span><span class="o">&gt;</span>
</pre></div>


<p>After being turned into a BeautifulSoup object, each HTML tag is also an object with attributes (such as 'class_' as seen above) and methods; this makes finding pieces of the webpage fairly intuitive. </p>
<p>With this, we can now write a few lines of code to take what we want from Rex's blog. I am going to take the date, the entirety of the text in the post body (to be parsed through at a later time).</p>
<div class="highlight"><pre><span class="n">date</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;h2&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span> <span class="s">&#39;date-header&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
<span class="n">post_body</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&quot;post-body&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</pre></div>


<h3>Crawling Through Pages</h3>
<p>Rex's blog has around 3000 crossword puzzle pages, and we'd like to scrape data off of each of them. We can easily find what we want on each page, but now we need to write a little function to crawl through each page and pull out the above data. In order to do this, we need to be able to find the link to the prior post on each page. Unfortunately, Rex's link format has changed over his years of posting (as has his post-body format, which is why I took that all as one chunk for each page), so it's a bit difficult to just search by date for the link to the prior post. Thankfully, at the bottom of each page is a link titled "Older Post", which easily takes us where we want to go. Links can be found within a page's <code>&lt;a&gt;</code> tags, with the links as the 'href' attribute. The "Older Post" link has class_='blog-pager-older-link'), so we can find the link by</p>
<div class="highlight"><pre><span class="n">page_line</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&#39;blog-pager-older-link&#39;</span><span class="p">)</span>
<span class="n">next_page</span> <span class="o">=</span> <span class="n">page_line</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)</span>
</pre></div>


<p>We now have all the information we need to crawl through Rex's blog, and the following functions will enable us to do so:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="n">soup</span><span class="p">):</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Given a page from Rex&#39;s blog, return the post date, body, and link to the prior post</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;h2&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span> <span class="s">&#39;date-header&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="n">post_body</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&quot;post-body&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="n">page_line</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&#39;blog-pager-older-link&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">page_line</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">break</span>
    <span class="n">next_page</span> <span class="o">=</span> <span class="n">page_line</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">date</span><span class="p">,</span> <span class="n">post_body</span><span class="p">,</span> <span class="n">next_page</span>

<span class="k">def</span> <span class="nf">WriteErrors</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Write list to a file</span>
<span class="sd">&#39;&#39;&#39;</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;error_list&quot;</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
      <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&amp;s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">crawlPages</span><span class="p">(</span><span class="n">startPage</span><span class="p">):</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Given a starting page, crawl the blog until there is no longer a &quot;next page&quot; link. </span>
<span class="sd">Return a list of post dates and a list of post bodies, along with writing an error</span>
<span class="sd">log for all URLErrors. </span>
<span class="sd">&#39;&#39;&#39;</span>  
  <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">web_page</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">startPage</span><span class="p">)</span>
  <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span>
  <span class="n">b</span><span class="o">=</span><span class="mi">0</span>
  <span class="n">errorCount</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="n">page_line</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">date</span><span class="p">,</span> <span class="n">post_body</span><span class="p">,</span> <span class="n">next_page</span> <span class="o">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>
    <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_body</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">next_page</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">next_page</span><span class="p">)</span>
      <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">next_page</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">URLError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;Prior Date is&#39;</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="s">&#39;: URLError = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
      <span class="k">print</span> <span class="n">error</span>
      <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
      <span class="n">errorCount</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">b</span><span class="o">+=</span><span class="mi">1</span>
  <span class="n">WriteErrors</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dates</span><span class="p">,</span> <span class="n">body</span>
</pre></div>


<p>While crawling through Rex's blog, occasionally I would get this error:
"urllib2.HTTPError: HTTP Error 503: Service Unavailable"
which would cause my code to quit. The try/except syntax enables the code to keep running after it has encountered this error, and also allows me to create a log of which pages I missed. The crawlPages function then returns a list of all post dates and all post bodies(alternatively I could have stored each paired date and post in a nested list structure, which would probably have been better). </p>
<p>I would now like to write all of this to a csv file for later use. However, the aquired data is all in unicode, which cannot be written to a csv file. We need to encode our data as UTF-8, which can be done using the following function. It loops through a list and encodes each element in UTF-8 while ignoring characters that it cannot handle.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Encode input in UTF-8</span>
<span class="sd">&#39;&#39;&#39;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">convert</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">]</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">input</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>


<p>After encoding everything, I created a pandas dataframe (I'll discuss pandas in my next post) out of my two lists in order to simply write to csv. </p>
<div class="highlight"><pre><span class="n">dates</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">df</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dates2</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">&#39;post&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">body2</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">&#39;/Users/Brian/Desktop/Crosswords/NYT_Xword_Data.csv&#39;</span><span class="p">)</span>
</pre></div>


<h3>Wrapping Up</h3>
<p>We have successfully crawled through Rex's blog and created a database to start playing around with. In my next post, I'll talk about parsing through all of the post-bodies in order to get out the real information that I was after!</p>

      </div><!-- /.entry-content -->

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://twitter.github.com/bootstrap">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script src="http://code.jquery.com/jquery.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>
</body>
</html>